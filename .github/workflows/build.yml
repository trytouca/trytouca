# Copyright 2022 Touca, Inc. Subject to Apache-2.0 License.

name: touca-build

on:
  push:
    paths-ignore:
      - ".github/workflows/self-host-install.yml"
    branches:
      - main
      - "feature/**"

jobs:
  build-docs:
    name: build-docs
    runs-on: ubuntu-20.04
    timeout-minutes: 15
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v3
      - uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: .github/path-filters.yml
      - name: get version number
        if: steps.changes.outputs.docs == 'true'
        id: params
        run: |
          git fetch --prune --unshallow --tags
          echo "::set-output name=release::${{ github.repository_owner == 'trytouca' && github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/release/v')) }}"
      - name: authenticate to aws
        if: |
          steps.changes.outputs.docs == 'true' && steps.params.outputs.release == 'true'
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-region: ${{ secrets.AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_ROLE }}
      - uses: actions/setup-node@v2
        if: steps.changes.outputs.docs == 'true'
      - uses: actions/cache@v2
        if: steps.changes.outputs.docs == 'true'
        with:
          path: ${{ github.workspace }}/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-node-
            ${{ runner.os }}-
      - name: build doc
        if: steps.changes.outputs.docs == 'true'
        run: |
          yarn --cwd=docs install
          yarn --cwd=docs build
      - name: push doc to aws
        if: |
          steps.changes.outputs.docs == 'true' && steps.params.outputs.release == 'true'
        run: |
          aws s3 sync ./docs/build/ ${{ secrets.AWS_PROD_S3_BUCKET_WEB }}/docs/ --exclude "*.html" --exclude "*.xml" --cache-control public,max-age=31536000,immutable
          aws s3 sync ./docs/build/ ${{ secrets.AWS_PROD_S3_BUCKET_WEB }}/docs/ --exclude "*" --include "*.html" --include "*.xml" --cache-control no-cache

  lint-links:
    name: lint-links
    runs-on: ubuntu-20.04
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v3
      - uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: .github/path-filters.yml
      - uses: gaurav-nelson/github-action-markdown-link-check@v1
        if: steps.changes.outputs.links == 'true'
        with:
          folder-path: examples,sdk

  build-sdk-cpp-local:
    name: build-sdk-cpp-local
    runs-on: ubuntu-20.04
    timeout-minutes: 15
    defaults:
      run:
        working-directory: ./sdk/cpp
    strategy:
      matrix:
        cxx: [g++-9, clang++-9]
    steps:
      - uses: actions/checkout@v3
      - uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: .github/path-filters.yml
      - run: ./build.sh --with-tests --with-cli --with-examples
        if: steps.changes.outputs.sdk_cpp == 'true'
      - run: ./build.sh --test
        if: steps.changes.outputs.sdk_cpp == 'true'

  build-sdk-cpp-conan:
    name: build-sdk-cpp-conan
    runs-on: ubuntu-20.04
    timeout-minutes: 15
    permissions:
      id-token: write
      contents: read
    defaults:
      run:
        working-directory: ./sdk/cpp
    strategy:
      matrix:
        cxx: [g++-9, clang++-9]
    steps:
      - uses: actions/checkout@v3
      - uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: .github/path-filters.yml
      - uses: actions/setup-python@v1
        if: steps.changes.outputs.sdk_cpp == 'true'
      - name: cache conan
        if: steps.changes.outputs.sdk_cpp == 'true'
        uses: actions/cache@v2
        env:
          cache-name: cache-conan-packages
        with:
          path: ~/.conan
          key: |
            ${{ runner.os }}-build-${{ env.cache-name }}-${{ matrix.cxx }}-${{ hashFiles('**/conanfile.py') }}
          restore-keys: |
            ${{ runner.os }}-build-${{ env.cache-name }}-${{ matrix.cxx }}-
            ${{ runner.os }}-build-${{ env.cache-name }}-
            ${{ runner.os }}-build-
            ${{ runner.os }}-
      - name: install conan
        if: steps.changes.outputs.sdk_cpp == 'true'
        run: |
          pip install conan --no-cache-dir --upgrade
          conan profile new default --detect --force
          conan profile update settings.compiler.libcxx=libstdc++11 default
      - name: build components
        if: steps.changes.outputs.sdk_cpp == 'true'
        run: ./build.sh --with-tests --with-cli --with-examples
      - name: run unit tests
        if: steps.changes.outputs.sdk_cpp == 'true'
        run: ./build.sh --test
      - name: create conan package
        if: steps.changes.outputs.sdk_cpp == 'true'
        run: ./build.sh --package
      - name: push conan package
        if: |
          steps.changes.outputs.sdk_cpp == 'true' && github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          conan remote add --force touca-cpp https://getweasel.jfrog.io/artifactory/api/conan/touca-cpp
          conan user -p ${{ secrets.JFROG_API_KEY }} -r touca-cpp ${{ secrets.JFROG_USERNAME }}
          conan upload "touca/1.5.2" --confirm --parallel -r touca-cpp --all

  build-sdk-cpp-docs:
    name: build-sdk-cpp-docs
    runs-on: ubuntu-20.04
    timeout-minutes: 15
    permissions:
      id-token: write
      contents: read
    defaults:
      run:
        working-directory: ./sdk/cpp
    needs:
      - build-sdk-cpp-local
      - build-sdk-cpp-conan
    steps:
      - uses: actions/checkout@v3
      - uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: .github/path-filters.yml
      - name: authenticate to aws
        if: |
          steps.changes.outputs.sdk_cpp == 'true' && github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-region: ${{ secrets.AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_ROLE }}
      - uses: actions/setup-python@v2
        if: steps.changes.outputs.sdk_cpp == 'true'
        with:
          python-version: 3.9
      - name: install dependencies
        if: steps.changes.outputs.sdk_cpp == 'true'
        run: |
          sudo apt-get install doxygen
          python -m pip install --upgrade pip
          pip install --no-cache-dir --upgrade -r docs/sphinx/requirements.txt
      - name: generate docs
        if: steps.changes.outputs.sdk_cpp == 'true'
        run: ./build.sh --docs
      - name: push docs to aws
        if:
          steps.changes.outputs.sdk_cpp == 'true' && github.event_name == 'push'
          && github.ref == 'refs/heads/main'
        run: |
          tar -zcf cpp-docs-reference.tar.gz local/docs/html
          aws s3 cp cpp-docs-reference.tar.gz ${{ secrets.AWS_DEV_S3_BUCKET_BUILD }}/v1.4.0/

  build-sdk-cpp-coverage:
    name: build-sdk-cpp-coverage
    runs-on: ubuntu-20.04
    timeout-minutes: 15
    permissions:
      id-token: write
      contents: read
    defaults:
      run:
        working-directory: ./sdk/cpp
    if: |
      github.repository_owner == 'trytouca' && github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs:
      - build-sdk-cpp-local
      - build-sdk-cpp-conan
    steps:
      - uses: actions/checkout@v3
      - uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: .github/path-filters.yml
      - name: authenticate to aws
        if: steps.changes.outputs.sdk_cpp == 'true'
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-region: ${{ secrets.AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_ROLE }}
      - name: install dependencies
        if: steps.changes.outputs.sdk_cpp == 'true'
        run: pip install gcovr==5.0
      - name: generate coverage
        if: steps.changes.outputs.sdk_cpp == 'true'
        run: ./build.sh --coverage
      - name: push coverage to aws
        if: steps.changes.outputs.sdk_cpp == 'true'
        run: |
          tar -zcf cpp-test-coverage.tar.gz ./local/coverage/html
          aws s3 cp cpp-test-coverage.tar.gz ${{ secrets.AWS_DEV_S3_BUCKET_BUILD }}/v1.4.0/
      - name: upload coverage to codecov
        if: steps.changes.outputs.sdk_cpp == 'true'
        uses: codecov/codecov-action@v2
        env:
          OS: ${{ runner.os }}
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./sdk/cpp/local/coverage/coverage.xml
          flags: sdk-cpp
          env_vars: OS
          fail_ci_if_error: true

  build-sdk-java-local:
    name: build-sdk-java-local
    runs-on: ubuntu-20.04
    timeout-minutes: 15
    permissions:
      id-token: write
      contents: read
    defaults:
      run:
        working-directory: ./sdk/java
    steps:
      - uses: actions/checkout@v3
      - uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: .github/path-filters.yml
      - name: authenticate to aws
        if: |
          steps.changes.outputs.sdk_java == 'true' && github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-region: ${{ secrets.AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_ROLE }}
      - uses: gradle/wrapper-validation-action@v1
        if: steps.changes.outputs.sdk_java == 'true'
      - uses: actions/setup-java@v2
        if: steps.changes.outputs.sdk_java == 'true'
        with:
          distribution: "adopt"
          java-version: "8"
      - name: cache gradle dependencies
        if: steps.changes.outputs.sdk_java == 'true'
        uses: actions/cache@v2
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: |
            ${{ runner.os }}-gradle-${{ env.cache-name }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
      - name: build java sdk
        if: steps.changes.outputs.sdk_java == 'true'
        run: ./gradlew build
      - name: publish sdk to maven
        if: |
          steps.changes.outputs.sdk_java == 'true' && github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: ./gradlew publish
        env:
          ORG_GRADLE_PROJECT_ossrhUsername: ${{ secrets.SONATYPE_USERNAME }}
          ORG_GRADLE_PROJECT_ossrhPassword: ${{ secrets.SONATYPE_PASSWORD }}
          ORG_GRADLE_PROJECT_signingKey: ${{ secrets.GRADLE_SIGNING_KEY }}
          ORG_GRADLE_PROJECT_signingKeyId: ${{ secrets.GRADLE_SIGNING_KEY_ID }}
          ORG_GRADLE_PROJECT_signingPassword:
            ${{ secrets.GRADLE_SIGNING_PASSWORD }}
      - name: push docs to aws
        if: |
          steps.changes.outputs.sdk_java == 'true' && github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          tar -zcf java-docs-external.tar.gz touca/build/docs/javadoc
          aws s3 cp java-docs-external.tar.gz ${{ secrets.AWS_DEV_S3_BUCKET_BUILD }}/v1.4.0/
      - name: push coverage to aws
        if: |
          steps.changes.outputs.sdk_java == 'true' && github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          tar -zcf java-test-coverage.tar.gz touca/build/reports/jacoco/test/html
          aws s3 cp java-test-coverage.tar.gz ${{ secrets.AWS_DEV_S3_BUCKET_BUILD }}/v1.4.0/
      - name: cleanup gradle cache
        if: steps.changes.outputs.sdk_java == 'true'
        run: |
          rm -f ~/.gradle/caches/modules-2/modules-2.lock
          rm -f ~/.gradle/caches/modules-2/gc.properties
      - name: upload coverage to codecov
        if: |
          steps.changes.outputs.sdk_java == 'true' && github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: codecov/codecov-action@v2
        env:
          OS: ${{ runner.os }}
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./sdk/java/touca/build/reports/jacoco/test/jacocoTestReport.xml
          flags: sdk-java
          env_vars: OS
          fail_ci_if_error: true

  build-sdk-js-local:
    name: build-sdk-js-local
    runs-on: ubuntu-20.04
    timeout-minutes: 15
    permissions:
      id-token: write
      contents: read
    defaults:
      run:
        working-directory: ./sdk/js
    strategy:
      matrix:
        node-version: [12, 14, 16]
    steps:
      - uses: actions/checkout@v3
      - uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: .github/path-filters.yml
      - name: authenticate to aws
        if: |
          steps.changes.outputs.sdk_js == 'true' && github.ref == 'refs/heads/main' && matrix.node-version == 14 && github.event_name == 'push'
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-region: ${{ secrets.AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_ROLE }}
      - uses: actions/setup-node@v2
        if: steps.changes.outputs.sdk_js == 'true'
        with:
          node-version: ${{ matrix.node-version }}
      - uses: actions/cache@v2
        if: steps.changes.outputs.sdk_js == 'true'
        env:
          CACHED_DEPENDENCY_PATHS: |
            ${{ github.workspace }}/node_modules
            ${{ github.workspace }}/packages/**/node_modules
        with:
          path: ${{ env.CACHED_DEPENDENCY_PATHS }}
          key: ${{ runner.os }}-node-${{ hashFiles('yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-node-
            ${{ runner.os }}-
      - name: build js components
        if: steps.changes.outputs.sdk_js == 'true'
        run: |
          yarn install
          yarn build
          yarn test
      - name: lint source code
        if: |
          steps.changes.outputs.sdk_js == 'true' && matrix.node-version == 14 && github.event_name == 'push'
        run: yarn lint
      - name: generate docs
        if: |
          steps.changes.outputs.sdk_js == 'true' && matrix.node-version == 14 && github.event_name == 'push'
        run: yarn docs
      - name: push docs to aws
        if:
          steps.changes.outputs.sdk_js == 'true' && github.ref ==
          'refs/heads/main' && matrix.node-version == 14 && github.event_name ==
          'push'
        run: |
          tar -zcf js-node-docs-external.tar.gz local/docs
          aws s3 cp js-node-docs-external.tar.gz ${{ secrets.AWS_DEV_S3_BUCKET_BUILD }}/v1.4.0/
      - name: push coverage to aws
        if: |
          steps.changes.outputs.sdk_js == 'true' && github.ref == 'refs/heads/main' && matrix.node-version == 14 && github.event_name == 'push'
        run: |
          tar -zcf js-node-test-coverage.tar.gz packages/node/coverage/lcov-report
          aws s3 cp js-node-test-coverage.tar.gz ${{ secrets.AWS_DEV_S3_BUCKET_BUILD }}/v1.4.0/
      - name: upload coverage to codecov
        if: |
          steps.changes.outputs.sdk_js == 'true' && github.ref == 'refs/heads/main' && matrix.node-version == 14 && github.event_name == 'push'
        uses: codecov/codecov-action@v2
        env:
          OS: ${{ runner.os }}
          NODE: ${{ matrix.node-version }}
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./sdk/js/packages/node/coverage/clover.xml
          flags: sdk-js
          env_vars: OS,NODE
          fail_ci_if_error: true

  build-sdk-python-local:
    name: build-sdk-python-local
    runs-on: ubuntu-20.04
    timeout-minutes: 15
    permissions:
      id-token: write
      contents: read
    defaults:
      run:
        working-directory: ./sdk/python
    strategy:
      matrix:
        python-version: [3.6, 3.7, 3.8, 3.9, "3.10"]
    steps:
      - uses: actions/checkout@v3
      - uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: .github/path-filters.yml
      - name: authenticate to aws
        if: |
          steps.changes.outputs.sdk_python == 'true' && github.ref == 'refs/heads/main' && matrix.python-version == 3.9 && github.event_name == 'push'
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-region: ${{ secrets.AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_ROLE }}
      - uses: actions/setup-python@v2
        if: steps.changes.outputs.sdk_python == 'true'
        with:
          python-version: ${{ matrix.python-version }}
      - name: cache pip dependencies
        if: steps.changes.outputs.sdk_python == 'true'
        uses: actions/cache@v2
        env:
          cache-name: cache-pip-dependencies
        with:
          path: ~/.cache/pip
          key: |
            ${{ runner.os }}-build-${{ env.cache-name }}-${{ matrix.python-version }}-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-build-${{ env.cache-name }}-${{ matrix.python-version }}-
            ${{ runner.os }}-build-${{ env.cache-name }}-
            ${{ runner.os }}-build
            ${{ runner.os }}-
      - name: install pip dependencies
        if: steps.changes.outputs.sdk_python == 'true'
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]
      - name: run unit tests
        if: steps.changes.outputs.sdk_python == 'true'
        run: |
          make test
      - name: generate docs
        if: steps.changes.outputs.sdk_python == 'true'
        run: |
          make docs
      - name: push docs to aws
        if:
          steps.changes.outputs.sdk_python == 'true' && github.ref ==
          'refs/heads/main' && matrix.python-version == 3.9 && github.event_name
          == 'push'
        run: |
          tar -zcf python-docs-external.tar.gz local/docs
          aws s3 cp python-docs-external.tar.gz ${{ secrets.AWS_DEV_S3_BUCKET_BUILD }}/v1.4.0/
      - name: push coverage to aws
        if: |
          steps.changes.outputs.sdk_python == 'true' && github.ref == 'refs/heads/main' && matrix.python-version == 3.9 && github.event_name == 'push'
        run: |
          tar -zcf python-test-coverage.tar.gz local/tests
          aws s3 cp python-test-coverage.tar.gz ${{ secrets.AWS_DEV_S3_BUCKET_BUILD }}/v1.4.0/
      - name: build package distributable
        if: |
          steps.changes.outputs.sdk_python == 'true' && github.ref == 'refs/heads/main' && matrix.python-version == 3.9
        env:
          TWINE_NON_INTERACTIVE: true
        run: |
          pip install setuptools twine wheel
          python setup.py sdist bdist_wheel
          twine check dist/*
      - name: upload coverage to codecov
        if: |
          steps.changes.outputs.sdk_python == 'true' && github.ref == 'refs/heads/main' && matrix.python-version == 3.9 && github.event_name == 'push'
        uses: codecov/codecov-action@v2
        env:
          OS: ${{ runner.os }}
          PYTHON: ${{ matrix.python-version }}
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./sdk/python/local/tests/coverage.xml
          flags: sdk-python
          env_vars: OS,PYTHON
          fail_ci_if_error: true

  run-examples-cpp:
    name: run-examples-cpp
    runs-on: ubuntu-20.04
    timeout-minutes: 15
    defaults:
      run:
        working-directory: ./examples/cpp
    strategy:
      matrix:
        cxx: [g++-9]
    steps:
      - uses: actions/checkout@v3
      - uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: .github/path-filters.yml
      - name: get version number
        if: steps.changes.outputs.examples_cpp == 'true'
        id: params
        run: |
          git fetch --prune --unshallow --tags
          echo "::set-output name=version::$(git describe --tags --abbrev=4)"
      - name: build cpp examples
        if: steps.changes.outputs.examples_cpp == 'true'
        run: ./build.sh
      - name: run example cpp application
        if: |
          steps.changes.outputs.examples_cpp == 'true' && github.ref == 'refs/heads/main'
        env:
          TOUCA_API_KEY: ${{ secrets.TOUCA_API_KEY }}
          TOUCA_API_URL: https://api.touca.io/@/examples/cpp
          TOUCA_TEST_VERSION: ${{ steps.params.outputs.version }}
        run: |
          mkdir -p ./local/results
          ./local/dist/bin/example_cpp_main_api

  run-examples-java:
    name: run-examples-java
    runs-on: ubuntu-20.04
    timeout-minutes: 15
    defaults:
      run:
        working-directory: ./examples/java
    steps:
      - uses: actions/checkout@v3
      - uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: .github/path-filters.yml
      - uses: actions/setup-java@v2
        if: steps.changes.outputs.examples_java == 'true'
        with:
          distribution: "adopt"
          java-version: "8"
      - name: get version number
        if: steps.changes.outputs.examples_java == 'true'
        id: params
        run: |
          git fetch --prune --unshallow --tags
          echo "::set-output name=version::$(git describe --tags --abbrev=4)"
      - uses: actions/cache@v2
        if: steps.changes.outputs.examples_java == 'true'
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: |
            ${{ runner.os }}-gradle-${{ env.cache-name }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
      - name: build java examples
        if: steps.changes.outputs.examples_java == 'true'
        run: ./gradlew build
      - name: run example java application
        if: |
          steps.changes.outputs.examples_java == 'true' && github.ref == 'refs/heads/main'
        env:
          TOUCA_API_KEY: ${{ secrets.TOUCA_API_KEY }}
          TOUCA_API_URL: https://api.touca.io/@/examples/java
          TOUCA_TEST_VERSION: ${{ steps.params.outputs.version }}
        run: ./gradlew runExampleMain
      - name: cleanup gradle cache
        if: steps.changes.outputs.examples_java == 'true'
        run: |
          rm -f ~/.gradle/caches/modules-2/modules-2.lock
          rm -f ~/.gradle/caches/modules-2/gc.properties

  run-examples-js:
    name: run-examples-js
    runs-on: ubuntu-20.04
    timeout-minutes: 15
    defaults:
      run:
        working-directory: ./examples/js
    steps:
      - uses: actions/checkout@v3
      - uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: .github/path-filters.yml
      - uses: actions/setup-node@v2
        if: steps.changes.outputs.examples_js == 'true'
        with:
          node-version: 14
      - name: get version number
        if: steps.changes.outputs.examples_js == 'true'
        id: params
        run: |
          git fetch --prune --unshallow --tags
          echo "::set-output name=version::$(git describe --tags --abbrev=4)"
      - uses: actions/cache@v2
        if: steps.changes.outputs.examples_js == 'true'
        with:
          path: |
            ${{ github.workspace }}/js/node_modules
            ${{ github.workspace }}/js/packages/**/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-node-
            ${{ runner.os }}-
      - name: build js examples
        if: steps.changes.outputs.examples_js == 'true'
        run: |
          yarn install
          yarn build
      - name: run example js application
        if: |
          steps.changes.outputs.examples_js == 'true' && github.ref == 'refs/heads/main'
        env:
          TOUCA_API_KEY: ${{ secrets.TOUCA_API_KEY }}
          TOUCA_API_URL: https://api.touca.io/@/examples/javascript
          TOUCA_TEST_VERSION: ${{ steps.params.outputs.version }}
        run: |
          yarn --cwd=02_node_main_api test:touca

  run-examples-python:
    name: run-examples-python
    runs-on: ubuntu-20.04
    timeout-minutes: 15
    defaults:
      run:
        working-directory: ./examples/python
    steps:
      - uses: actions/checkout@v3
      - uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: .github/path-filters.yml
      - uses: actions/setup-python@v2
        if: steps.changes.outputs.examples_python == 'true'
        with:
          python-version: 3.9
      - name: get version number
        if: steps.changes.outputs.examples_python == 'true'
        id: params
        run: |
          git fetch --prune --unshallow --tags
          echo "::set-output name=version::$(git describe --tags --abbrev=4 | tail -c 6 | sed "s/^/$(python sdk/python/setup.py --version)-/")"
      - name: run example python application
        if: |
          steps.changes.outputs.examples_python == 'true' && github.ref == 'refs/heads/main'
        env:
          TOUCA_API_KEY: ${{ secrets.TOUCA_API_KEY }}
          TOUCA_API_URL: https://api.touca.io/@/examples/python
          TOUCA_TEST_VERSION: ${{ steps.params.outputs.version }}
        run: |
          cd 02_python_main_api
          pip install touca
          touca

  build-web:
    name: build-web
    runs-on: ubuntu-20.04
    timeout-minutes: 15
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v3
      - uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: .github/path-filters.yml
      - name: get version number
        id: params
        run: |
          echo "::set-output name=release::${{ github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/release/v')) }}"
      - name: authenticate to aws
        if: |
          steps.changes.outputs.web == 'true' && steps.params.outputs.release == 'true'
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-region: ${{ secrets.AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_ROLE }}
      - uses: actions/setup-node@v2
        if: steps.changes.outputs.web == 'true'
      - uses: actions/cache@v2
        if: steps.changes.outputs.web == 'true'
        with:
          path: ${{ github.workspace }}/web/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('web/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-node-
            ${{ runner.os }}-
      - name: build web
        if: steps.changes.outputs.web == 'true'
        env:
          NEXT_TELEMETRY_DISABLED: 1
        run: |
          yarn --cwd=web install
          yarn --cwd=web build
          yarn --cwd=web lint
          yarn --cwd=web export
      - name: push web to aws
        if: |
          steps.changes.outputs.web == 'true' && steps.params.outputs.release == 'true'
        run: |
          aws s3 sync ./web/out/ ${{ secrets.AWS_PROD_S3_BUCKET_WEB }} --exclude "*.html" --exclude "*.xml" --cache-control public,max-age=31536000,immutable
          aws s3 sync ./web/out/ ${{ secrets.AWS_PROD_S3_BUCKET_WEB }} --exclude "*" --include "*.html" --include "*.xml" --cache-control no-cache

  build-api:
    name: build-api
    runs-on: ubuntu-20.04
    timeout-minutes: 15
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v3
      - name: authenticate to aws
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-region: ${{ secrets.AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_ROLE }}
      - uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: .github/path-filters.yml
      - name: get version number
        id: params
        run: |
          echo "::set-output name=release::${{ github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/release/v')) }}"
          echo "::set-output name=buckets::${{ secrets.AWS_DEV_S3_BUCKET_BUILD }}/v1.4.0"

      - uses: actions/setup-node@v2
        if: steps.changes.outputs.api == 'true'
      - uses: actions/cache@v2
        if: steps.changes.outputs.api == 'true'
        with:
          path: ${{ github.workspace }}/api/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('api/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-node-
            ${{ runner.os }}-

      - name: build api
        if: steps.changes.outputs.api == 'true'
        run: |
          yarn --cwd=api install
          yarn --cwd=api build
          yarn --cwd=api lint
          yarn --cwd=api test
          yarn --cwd=api docs
          tar -zcf api.tar.gz api/dist
          tar -zcf api-docs-external.tar.gz api/local/docs/external
          tar -zcf api-docs-internal.tar.gz api/local/docs/internal
          tar -zcf api-test-coverage.tar.gz api/local/tests

      - name: push api to aws
        if: |
          steps.changes.outputs.api == 'true' && steps.params.outputs.release == 'true'
        run: |
          aws s3 cp api.tar.gz ${{ steps.params.outputs.buckets }}/
          aws s3 cp api-docs-external.tar.gz ${{ steps.params.outputs.buckets }}/
          aws s3 cp api-docs-internal.tar.gz ${{ steps.params.outputs.buckets }}/
          aws s3 cp api-test-coverage.tar.gz ${{ steps.params.outputs.buckets }}/
          aws s3 sync ./api/local/docs/external/ ${{ secrets.AWS_PROD_S3_BUCKET_APP }}/docs/api/ --include "*" --cache-control no-cache

      - name: pull api from aws
        if: steps.changes.outputs.api == 'false'
        run: |
          aws s3 cp ${{ steps.params.outputs.buckets }}/api.tar.gz .

      - uses: actions/upload-artifact@v2
        with:
          name: api-bundle
          path: ${{ github.workspace }}/api.tar.gz
          retention-days: 1

  build-app:
    name: build-app
    runs-on: ubuntu-20.04
    timeout-minutes: 15
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v3
      - name: authenticate to aws
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-region: ${{ secrets.AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_ROLE }}
      - uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: .github/path-filters.yml
      - name: get version number
        id: params
        run: |
          echo "::set-output name=release::${{ github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/release/v')) }}"
          echo "::set-output name=buckets::${{ secrets.AWS_DEV_S3_BUCKET_BUILD }}/v1.4.0"

      - uses: actions/setup-node@v2
        if: steps.changes.outputs.app == 'true'
      - uses: actions/cache@v2
        if: steps.changes.outputs.app == 'true'
        with:
          path: ${{ github.workspace }}/app/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('app/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-node-
            ${{ runner.os }}-
      - name: build app
        if: steps.changes.outputs.app == 'true'
        run: |
          yarn --cwd=app install --frozen-lockfile
          yarn --cwd=app build
          yarn --cwd=app lint
          tar -zcf app.tar.gz app/dist
      - name: push app to app.touca.io
        if: |
          steps.changes.outputs.app == 'true' && steps.params.outputs.release == 'true'
        run: |
          aws s3 cp app.tar.gz ${{ steps.params.outputs.buckets }}/
          yarn --cwd=app build --configuration=cloud --delete-output-path
          aws s3 sync ./app/dist/ ${{ secrets.AWS_PROD_S3_BUCKET_APP }} --exclude "*" --include "*.*.js" --include "*.*.css" --cache-control public,max-age=31536000,immutable
          aws s3 sync ./app/dist/ ${{ secrets.AWS_PROD_S3_BUCKET_APP }} --exclude "*.*.js" --exclude "*.*.css" --cache-control no-cache
      - name: pull app from aws
        if: steps.changes.outputs.app == 'false'
        run: aws s3 cp ${{ steps.params.outputs.buckets }}/app.tar.gz .

      - uses: actions/upload-artifact@v2
        with:
          name: app-bundle
          path: ${{ github.workspace }}/app.tar.gz
          retention-days: 1

  build-cmp:
    name: build-cmp
    runs-on: ubuntu-20.04
    timeout-minutes: 15
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v3
      - name: authenticate to aws
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-region: ${{ secrets.AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_ROLE }}
      - uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: .github/path-filters.yml
      - name: get version number
        id: params
        run: |
          echo "::set-output name=release::${{ github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/release/v')) }}"
          echo "::set-output name=buckets::${{ secrets.AWS_DEV_S3_BUCKET_BUILD }}/v1.4.0"

      - uses: actions/setup-python@v1
        if: steps.changes.outputs.cmp == 'true'
      - name: install conan
        if: steps.changes.outputs.cmp == 'true'
        run: |
          pip install --no-cache-dir --upgrade conan
          conan profile new default --detect --force
          conan profile update settings.compiler.libcxx=libstdc++11 default
          conan remote add --force touca-cpp https://getweasel.jfrog.io/artifactory/api/conan/touca-cpp
      - name: build cmp
        if: steps.changes.outputs.cmp == 'true'
        run: |
          CONAN_SYSREQUIRES_MODE=enabled cmp/build.sh
          tar -zcf cmp.tar.gz cmp/local/dist

      - name: push cmp to aws
        if: |
          steps.changes.outputs.cmp == 'true' && steps.params.outputs.release == 'true'
        run: aws s3 cp cmp.tar.gz ${{ steps.params.outputs.buckets }}/

      - name: pull cmp from aws
        if: steps.changes.outputs.cmp == 'false'
        run: aws s3 cp ${{ steps.params.outputs.buckets }}/cmp.tar.gz .

      - uses: actions/upload-artifact@v2
        with:
          name: cmp-bundle
          path: ${{ github.workspace }}/cmp.tar.gz
          retention-days: 1

  build-server:
    name: build-server
    runs-on: ubuntu-20.04
    timeout-minutes: 15
    permissions:
      id-token: write
      contents: read
    needs:
      - build-api
      - build-app
      - build-cmp
    steps:
      - uses: actions/checkout@v3
      - uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: .github/path-filters.yml
      - uses: docker/setup-qemu-action@v2
      - uses: docker/setup-buildx-action@v2
      - name: get version number
        id: params
        run: |
          git fetch --prune --unshallow --tags
          echo "::set-output name=version::1.4.0"
          echo "::set-output name=release::${{ github.repository_owner == 'trytouca' && github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/release/v')) && (steps.changes.outputs.api == 'true' || steps.changes.outputs.app == 'true' || steps.changes.outputs.cmp == 'true') }}"
          echo "::set-output name=buckets::${{ secrets.AWS_DEV_S3_BUCKET_BUILD }}/v1.4.0"
      - uses: actions/download-artifact@v2
        if: steps.changes.outputs.api == 'true'
        with:
          name: api-bundle
          path: ${{ github.workspace }}
      - uses: actions/download-artifact@v2
        if: steps.changes.outputs.app == 'true'
        with:
          name: app-bundle
          path: ${{ github.workspace }}
      - uses: actions/download-artifact@v2
        if: steps.changes.outputs.cmp == 'true'
        with:
          name: cmp-bundle
          path: ${{ github.workspace }}
      - uses: actions/setup-node@v2
        if: steps.changes.outputs.api == 'true'
      - uses: actions/cache@v2
        if: steps.changes.outputs.api == 'true'
        with:
          path: ${{ github.workspace }}/api/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('api/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-node-
            ${{ runner.os }}-
      - name: install api dependencies
        if: steps.changes.outputs.api == 'true'
        run: yarn --cwd=api install --frozen-lockfile --production

      - name: authenticate to aws
        uses: aws-actions/configure-aws-credentials@v1
        if: steps.params.outputs.release == 'true'
        with:
          aws-region: ${{ secrets.AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_ROLE }}
      - name: login to docker container registry
        uses: docker/login-action@v2
        if: steps.params.outputs.release == 'true'
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
      - name: login to aws container registry
        uses: docker/login-action@v2
        if: steps.params.outputs.release == 'true'
        with:
          registry: ${{ secrets.AWS_PROD_ECR_REPO }}
      - name: push ops to aws
        if: |
          steps.changes.outputs.ops == 'true' && steps.params.outputs.release == 'true'
        run: |
          tar -zcf deployment-scripts.tar.gz ops
          aws s3 cp deployment-scripts.tar.gz ${{ steps.params.outputs.buckets }}/
          aws s3 cp ops/install.sh ${{ secrets.AWS_PROD_S3_BUCKET_WEB }}/install.sh
          aws s3 cp ops/install.dev.sh ${{ secrets.AWS_PROD_S3_BUCKET_WEB }}/install.dev.sh

      - name: prepare resources for building api docker image
        if: steps.changes.outputs.api == 'true'
        run: |
          mkdir -p ./stage/api/certs
          tar -xf api.tar.gz -C ./stage
          cp -r ./api/env ./stage/api/env
          cp -r ./api/samples ./stage/api/samples
          cp -r ./api/node_modules ./stage/api/node_modules
          curl -o ./stage/api/certs/cert.pem https://s3.amazonaws.com/rds-downloads/rds-combined-ca-bundle.pem
      - name: extract metadata for api docker image
        uses: docker/metadata-action@v4
        if: steps.changes.outputs.api == 'true'
        id: meta-api
        with:
          images: |
            touca/touca-api
            ${{ secrets.AWS_PROD_ECR_REPO }}/touca-api
          tags: |
            type=semver,pattern={{version}},value=${{ steps.params.outputs.version }}
            type=semver,pattern={{major}}.{{minor}},value=${{ steps.params.outputs.version }}
            type=semver,pattern={{major}},value=${{ steps.params.outputs.version }}
      - name: build api docker image
        uses: docker/build-push-action@v3
        if: steps.changes.outputs.api == 'true'
        with:
          context: stage
          file: ./config/docker/api.Dockerfile
          platforms: linux/amd64,linux/arm64
          push: ${{ steps.params.outputs.release == 'true' }}
          tags: ${{ steps.meta-api.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      - name: update docker hub description
        uses: peter-evans/dockerhub-description@v3
        if: |
          steps.changes.outputs.api == 'true' && steps.params.outputs.release == 'true'
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_PASSWORD }}
          repository: touca/touca-api
          readme-filepath: ./README.md

      - name: prepare resources for building app docker image
        if: steps.changes.outputs.app == 'true'
        run: |
          mkdir -p ./stage
          tar -xf app.tar.gz -C ./stage
          mkdir -p ./stage/app && cp ./app/nginx.conf ./stage/app/
      - name: extract metadata for app docker image
        uses: docker/metadata-action@v4
        if: steps.changes.outputs.app == 'true'
        id: meta-app
        with:
          images: |
            touca/touca-app
            ${{ secrets.AWS_PROD_ECR_REPO }}/touca-app
          tags: |
            type=semver,pattern={{version}},value=${{ steps.params.outputs.version }}
            type=semver,pattern={{major}}.{{minor}},value=${{ steps.params.outputs.version }}
            type=semver,pattern={{major}},value=${{ steps.params.outputs.version }}
      - name: build app docker image
        uses: docker/build-push-action@v3
        if: steps.changes.outputs.app == 'true'
        with:
          context: stage
          file: ./config/docker/app.Dockerfile
          platforms: linux/amd64,linux/arm64
          push: ${{ steps.params.outputs.release == 'true' }}
          tags: ${{ steps.meta-app.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      - name: update docker hub description
        uses: peter-evans/dockerhub-description@v3
        if: |
          steps.changes.outputs.app == 'true' && steps.params.outputs.release == 'true'
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_PASSWORD }}
          repository: touca/touca-app
          readme-filepath: ./README.md

      - name: prepare resources for building cmp docker image
        if: steps.changes.outputs.cmp == 'true'
        run: |
          mkdir -p ./stage
          tar -xf cmp.tar.gz -C ./stage
          mkdir -p ./stage/cmp/config && cp ./cmp/config/config.prod.json ./stage/cmp/config/
      - name: extract metadata for cmp docker image
        uses: docker/metadata-action@v4
        if: steps.changes.outputs.cmp == 'true'
        id: meta-cmp
        with:
          images: |
            touca/touca-cmp
            ${{ secrets.AWS_PROD_ECR_REPO }}/touca-cmp
          tags: |
            type=semver,pattern={{version}},value=${{ steps.params.outputs.version }}
            type=semver,pattern={{major}}.{{minor}},value=${{ steps.params.outputs.version }}
            type=semver,pattern={{major}},value=${{ steps.params.outputs.version }}
      - name: build cmp docker image
        uses: docker/build-push-action@v3
        if: steps.changes.outputs.cmp == 'true'
        with:
          context: stage
          file: ./config/docker/cmp.Dockerfile
          platforms: linux/amd64,linux/arm64
          push: ${{ steps.params.outputs.release == 'true' }}
          tags: ${{ steps.meta-cmp.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      - name: update docker hub description
        uses: peter-evans/dockerhub-description@v3
        if: |
          steps.changes.outputs.cmp == 'true' && steps.params.outputs.release == 'true'
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_PASSWORD }}
          repository: touca/touca-cmp
          readme-filepath: ./README.md
